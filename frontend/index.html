<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title></title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>

<body>

  <div class="container">
    <input type="text" class="taskName" placeholder="Add a task">
    <button class="addNewTask">Add</button>
    <div class="not-completed-taskleted-task">
      <h3>Not completed tasks</h3>



    </div>

    <div class="completed-task">
      <h3>Completed Tasks</h3>
    </div>
  </div>
  <div class="">
    <button class="auth-button">Logout</button>
  </div>

  <script type="text/javascript">
    $('.auth-button').click(function () {
      localStorage.removeItem('token')

      window.location.href = 'login.html';
    });

    function getAllData() {
      $('.task').remove();

      $.ajax({
        type: "GET",
        url: 'http://localhost:4001/api/task/all',
        headers: {
          token: localStorage.getItem('token')
        },
        success: function (response) {
          console.log(response);

          response.forEach(element => {
            createTaskElement(element.title, element._id, element.status);
          });
        },
        error: function (error) {
          window.location.href = 'login.html';
        }
      });
    };

    function createTaskElement(name, id, status) {
      var task = $('<div class="task"></div>').text(name || $('.taskName').val());
      var del = $('<i class="fas fa-trash-alt"></i>').click(function () {
        var p = $(this).parent();

        removeTask(id, function () {
          p.fadeOut(function () {
            p.remove();
          });
        });
      });

      var check = $('<i class="fas fa-check"></i>').click(function () {
        var that = $(this);

        updateTaskStatus(id, 1, that, function () {
          var p = that.parent();
          p.fadeOut(function () {
            $('.completed-task').append(p);
            p.fadeIn();
          });
          that.remove();
        });
      });

      /* create task */

      if (status === 1) {
        task.append(del);

        $('.completed-task').append(task);
      } else {
        task.append(del, check);
        $('.not-completed-taskleted-task').append(task);
      }
      //to clear the input
      $('.taskName').val("");
    }

    $('.taskName').on("keyup", function (e) {
      if (e.keyCode == 13 && $('.taskName').val() != "") {
        const name = name || $('.taskName').val();

        createATask(name, createTaskElement);
      }
    });

    $('.addNewTask').on('click', function () {
      var name = name || $('.taskName').val();

      createATask(name, createTaskElement);
    });

    function createATask(name, callback) {
      $.ajax({
        type: 'POST',
        url: 'http://localhost:4001/api/task/createTask',
        dataType: 'json',
        headers: {
          token: localStorage.getItem('token')
        },
        data: {
          title: name,
          description: 'default',
          status: 0
        },
        success: function (response) {
          console.log(response);
          callback(response.title, response._id, response.status);

          alert('Task Eklendi.');
        },
      });
    };

    function removeTask(taskId, callback) {
      $.ajax({
        type: 'DELETE',
        url: 'http://localhost:4001/api/task/delete',
        dataType: 'json',
        headers: {
          token: localStorage.getItem('token')
        },
        data: {
          id: taskId
        },
        success: function (response) {
          callback();

          alert('Task Silindi.');
        },
      });
    };

    function updateTaskStatus(taskId, status, { }, callback) {
      $.ajax({
        type: 'PUT',
        url: 'http://localhost:4001/api/task/update',
        dataType: 'json',
        headers: {
          token: localStorage.getItem('token')
        },
        data: {
          id: taskId,
          status: status
        },
        success: function (response) {
          callback();

          alert('Task Yapıldı.');
        },
      });
    };

    getAllData();
  </script>

</body>

</html>